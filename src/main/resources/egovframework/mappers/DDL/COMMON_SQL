- 공통코드 테이블 생성 
CREATE TABLE COMM_CODE (
	COMM_CD VARCHAR(20) DEFAULT concat('COM', lpad(nextval('sq_comm_code_comm_cd_seq'::regclass)::text, 7, '0'::text)) NOT NULL,
	UPPR_COMM_CD VARCHAR(20) NULL,
	COMM_KRNM VARCHAR(50) NOT NULL,
	COMM_EGNM VARCHAR(50) NOT NULL,
	USYN BPCHAR(1) DEFAULT 'Y'::bpchar NULL,
	SORT_SOD INT4 NULL,
	RGST_DT timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
	COMM_CD_ID VARCHAR(20) NULL,
	CONSTRAINT pk_comm_code PRIMARY KEY (COMM_CD)
);

-- 프로시저 생성 (UPPER CODE를 통해 하위 공통코드 목록 조회)
CREATE OR REPLACE FUNCTION PROC_UPPR_COMM_CD(VAL VARCHAR)
RETURNS TABLE(
      COMM_CD        VARCHAR
    , COMM_KRNM      VARCHAR
    , COMM_EGNM      VARCHAR
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
          A.COMM_CD
        , A.COMM_KRNM
        , A.COMM_EGNM
    FROM COMM_CODE  A
    WHERE A.USYN = 'Y'
    AND A.UPPR_COMM_CD = (
        SELECT B.COMM_CD 
        FROM COMM_CODE B
        WHERE B.COMM_CD_ID = VAL
    )
    ORDER BY SORT_SOD ASC;
END;
$$ LANGUAGE PLPGSQL; 
-- PROC_UPPR_COMM_CD 제거
DROP FUNCTION IF EXISTS PROC_UPPR_COMM_CD(VARCHAR);



-- 프로시저 생성 (코드를 통해 코드명(국문 검색)
CREATE OR REPLACE FUNCTION PROC_COMM_KRNM(VAL VARCHAR)
RETURNS TABLE(
    COMM_KRNM      VARCHAR
) AS $$
BEGIN
    RETURN QUERY
    SELECT A.COMM_KRNM
    FROM COMM_CODE A
    WHERE   A.USYN = 'Y'
		AND A.COMM_CD = VAL;
END;
$$ LANGUAGE PLPGSQL; 



-- 서비스 사용자 테이블 생성
CREATE TABLE SERVICE_USER (
	SEQ 	 	  INT4    	     PRIMARY KEY 
  , NICKNAME 	  VARCHAR(20)    UNIQUE NOT NULL
  , EMAIL 	 	  VARCHAR(254)   NOT NULL 
  , PASSWORD 	  CHAR(64) 	     NOT NULL
  , NAME 	 	  VARCHAR(20)    NOT NULL
  , GENDER        CHAR(1)
  , TEL      	  VARCHAR(13)    NOT NULL
  , CITY     	  VARCHAR(10)
  , DISTRICT 	  VARCHAR(10)
  , GRADE    	  VARCHAR(10)
  , DEL_YN        CHAR(1)        DEFAULT 'N'
  , PROFILE_IMAGE TEXT			 DEFAULT '/src/assets/common/profile_default.png'
  , PWD_UPD_DT 	  TIMESTAMP
  , LOGIN_DT      TIMESTAMP
  , JOIN_DT		  TIMESTAMP
);

COMMENT ON TABLE SERVICE_USER 			      IS '서비스 사용자';

COMMENT ON COLUMN SERVICE_USER.SEQ 		      IS '시퀀스';  
COMMENT ON COLUMN SERVICE_USER.NICKNAME       IS '닉네임';
COMMENT ON COLUMN SERVICE_USER.EMAIL 	      IS '이메일';
COMMENT ON COLUMN SERVICE_USER.PASSWORD       IS '비밀번호';
COMMENT ON COLUMN SERVICE_USER.NAME 	      IS '이름';
COMMENT ON COLUMN SERVICE_USER.TEL 	          IS '전화번호';
COMMENT ON COLUMN SERVICE_USER.CITY 	      IS '시(도)';
COMMENT ON COLUMN SERVICE_USER.DISTRICT       IS '구';
COMMENT ON COLUMN SERVICE_USER.GRADE          IS '등급';
COMMENT ON COLUMN SERVICE_USER.DEL_YN         IS '탈퇴여부';
COMMENT ON COLUMN SERVICE_USER.PROFILE_IMAGE  IS '프로필 이미지';
COMMENT ON COLUMN SERVICE_USER.PWD_UPD_DT     IS '비밀번호 변경일';
COMMENT ON COLUMN SERVICE_USER.LOGIN_DT  	  IS '로그인 일자';
COMMENT ON COLUMN SERVICE_USER.JOIN_DT        IS '가입일';
COMMENT ON COLUMN SERVICE_USER.GENDER         IS '성별';



-- 서비스 사용자 결제 내역 히스토리 테이블 생성
CREATE TABLE SERVICE_USER_AMOUNT_HISTORY (
	 USER_SEQ 	   INT4 
   , CHANGE_REASON VARCHAR(100)
   , BEFORE_AMOUNT NUMERIC(15, 0)
   , AFTER_AMOUNT  NUMERIC(15, 0)
   , USAGE_DATE    TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
   , STATUS        VARCHAR(10)
   , PAYMENT 	   VARCHAR(10)
   , FOREIGN KEY (USER_SEQ) REFERENCES SERVICE_USER(SEQ)
);
COMMENT ON TABLE SERVICE_USER_AMOUNT_HISTORY                IS '서비스 사용자 포인트 변경 히스토리';

COMMENT ON COLUMN SERVICE_USER_AMOUNT_HISTORY.USER_SEQ 	    IS '시퀀스'; 
COMMENT ON COLUMN SERVICE_USER_AMOUNT_HISTORY.CHANGE_REASON IS '변경사유'; 
COMMENT ON COLUMN SERVICE_USER_AMOUNT_HISTORY.BEFORE_AMOUNT IS '사용 전 금액'; 
COMMENT ON COLUMN SERVICE_USER_AMOUNT_HISTORY.AFTER_AMOUNT 	IS '사용 후 금액'; 
COMMENT ON COLUMN SERVICE_USER_AMOUNT_HISTORY.USAGE_DATE 	IS '변경 일자'; 
COMMENT ON COLUMN SERVICE_USER_AMOUNT_HISTORY.STATUS 	    IS '변경 상태'; 
COMMENT ON COLUMN SERVICE_USER_AMOUNT_HISTORY.PAYMENT 	    IS '결제 수단'; 



-- 서비스 사용자 적립금 내역 히스토리 테이블 생성
CREATE TABLE SERVICE_USER_DEPOSIT_HISTORY (
	USER_SEQ INT4 NOT NULL, 
	CHANGE_REASON VARCHAR(100),
	BEFORE_DEPOSIT NUMERIC(15),
	AFTER_DEPOSIT NUMERIC(15),
	USAGE_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	STATUS VARCHAR(20) NOT NULL
)

COMMENT ON TABLE SERVICE_USER_DEPOSIT_HISTORY                  IS '서비스 사용자 적립금 변경 히스토리';

COMMENT ON COLUMN SERVICE_USER_DEPOSIT_HISTORY.USER_SEQ 	   IS '시퀀스'; 
COMMENT ON COLUMN SERVICE_USER_DEPOSIT_HISTORY.CHANGE_REASON   IS '변경사유'; 
COMMENT ON COLUMN SERVICE_USER_DEPOSIT_HISTORY.BEFORE_DEPOSIT  IS '사용 전 금액'; 
COMMENT ON COLUMN SERVICE_USER_DEPOSIT_HISTORY.AFTER_DEPOSIT   IS '사용 후 금액'; 
COMMENT ON COLUMN SERVICE_USER_DEPOSIT_HISTORY.USAGE_DATE 	   IS '변경 일자'; 
COMMENT ON COLUMN SERVICE_USER_DEPOSIT_HISTORY.STATUS 	       IS '변경 상태'; 


-- 협업사 테이블 생성
CREATE TABLE SERVICE_STORE (
	SEQ 	 	      INT4    	     PRIMARY KEY 
  , OWNER_NAME 	      VARCHAR(20)    NOT NULL
  , EMAIL 	 	      VARCHAR(254)   NOT NULL 
  , TEL      	      VARCHAR(13)    NOT NULL
  , PASSWORD 	      CHAR(64) 	     NOT NULL
  , BUSINESS_NUMBER   VARCHAR(10)    NOT NULL
  , STORE_NAME        VARCHAR(50)    NOT NULL
  , STORE_NUMBER      VARCHAR(15)    NOT NULL
  , URL   			  TEXT 		   
  , INSTAGRAM         TEXT
  , CITY     	      VARCHAR(10)
  , DISTRICT 	      VARCHAR(10)
  , POST_CODE         VARCHAR(10)
  , ADDR  			  VARCHAR(200)
  , DETAIL_ADDR       VARCHAR(100)
  , EXTRA_ADDR        VARCHAR(50)
  , BANK			  VARCHAR(10)
  , ACCOUNT_NUMBER    VARCHAR(50)
  , PROFILE_IMAGE 	  TEXT
  , BUSINESS_REG_FILE TEXT
  , GRADE    	  	  VARCHAR(10)
  , JOIN_DT		  	  TIMESTAMP	   DEFAULT CURRENT_TIMESTAMP
  , LOGIN_DT      	  TIMESTAMP
  , PWD_UPD_DT 	  	  TIMESTAMP	   DEFAULT CURRENT_TIMESTAMP
  , DEL_YN        	  CHAR(1)      DEFAULT 'N'
);

COMMENT ON TABLE SERVICE_STORE 			         IS '협업사';

COMMENT ON COLUMN SERVICE_STORE.SEQ 		     IS '시퀀스';  
COMMENT ON COLUMN SERVICE_STORE.OWNER_NAME       IS '대표자명';
COMMENT ON COLUMN SERVICE_STORE.EMAIL 	         IS '대표자 이메일';
COMMENT ON COLUMN SERVICE_STORE.TEL 	         IS '대표자 전화번호';
COMMENT ON COLUMN SERVICE_STORE.PASSWORD       	 IS '비밀번호';
COMMENT ON COLUMN SERVICE_STORE.BUSINESS_NUMBER  IS '사업자 등록번호';
COMMENT ON COLUMN SERVICE_STORE.STORE_NAME 	     IS '매장명';
COMMENT ON COLUMN SERVICE_STORE.STORE_NUMBER 	 IS '매장 전화번호';
COMMENT ON COLUMN SERVICE_STORE.URL		  	 	 IS '웹사이트';
COMMENT ON COLUMN SERVICE_STORE.INSTAGRAM	 	 IS '인스타그램';
COMMENT ON COLUMN SERVICE_STORE.CITY 	         IS '시(도)';
COMMENT ON COLUMN SERVICE_STORE.DISTRICT         IS '구';
COMMENT ON COLUMN SERVICE_STORE.POST_CODE		 IS '우편번호';
COMMENT ON COLUMN SERVICE_STORE.ADDR 	 		 IS '주소';
COMMENT ON COLUMN SERVICE_STORE.DETAIL_ADDR 	 IS '상세 주소';
COMMENT ON COLUMN SERVICE_STORE.EXTRA_ADDR	 	 IS '참고 주소';
COMMENT ON COLUMN SERVICE_STORE.BANK 	 		 IS '은행';
COMMENT ON COLUMN SERVICE_STORE.ACCOUNT_NUMBER 	 IS '계좌번호';
COMMENT ON COLUMN SERVICE_STORE.PROFILE_IMAGE    IS '프로필 이미지';
COMMENT ON COLUMN SERVICE_STORE.BUSINESS_REG_FILE  IS '사업자등록';
COMMENT ON COLUMN SERVICE_STORE.GRADE            IS '등급';
COMMENT ON COLUMN SERVICE_STORE.JOIN_DT          IS '가입일';
COMMENT ON COLUMN SERVICE_STORE.LOGIN_DT  	     IS '로그인 일자';
COMMENT ON COLUMN SERVICE_STORE.PWD_UPD_DT       IS '비밀번호 변경일';
